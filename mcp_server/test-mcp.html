<!DOCTYPE html>
<html>
<head>
    <title>MCP SSE Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .button { padding: 10px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #005a87; }
        .log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
        .input-group { margin: 10px 0; }
        .input-group input { padding: 5px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>MCP SSE Test Client</h1>
        
        <div class="section">
            <h3>Connection Status</h3>
            <p>Status: <span id="status">Disconnected</span></p>
            <button class="button" onclick="connect()">Connect</button>
            <button class="button" onclick="disconnect()">Disconnect</button>
        </div>

        <div class="section">
            <h3>Test MCP Methods</h3>
            <button class="button" onclick="testToolsList()">Test tools/list</button>
            <button class="button" onclick="testToolsCall()">Test tools/call (get_orders)</button>
            
            <div class="input-group">
                <h4>Custom tools/call Test</h4>
                <input type="text" id="toolName" placeholder="Tool name" value="get_orders">
                <button class="button" onclick="testCustomToolCall()">Call Tool</button>
            </div>
        </div>

        <div class="section">
            <h3>Log</h3>
            <div id="log" class="log"></div>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let eventSource = null;
        let sessionId = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        async function connect() {
            try {
                log('Attempting to connect to MCP server...');
                
                // Connect to SSE endpoint
                eventSource = new EventSource('http://localhost:3000/connect');
                
                eventSource.onopen = function(event) {
                    log('SSE connection opened');
                    updateStatus('Connected');
                };

                eventSource.onmessage = function(event) {
                    log('SSE message received: ' + event.data);
                    
                    try {
                        const data = JSON.parse(event.data);
                        if (data.jsonrpc && data.method === 'sse/connection') {
                            log('Connection established: ' + data.params.message);
                        }
                        
                        // Extract sessionId from transport messages if available
                        if (data.sessionId) {
                            sessionId = data.sessionId;
                            log('Session ID: ' + sessionId);
                        }
                    } catch (e) {
                        log('Error parsing SSE data: ' + e.message);
                    }
                };

                eventSource.onerror = function(event) {
                    log('SSE error occurred: ' + JSON.stringify(event));
                    updateStatus('Error');
                };

                // Extract sessionId from URL if available
                setTimeout(() => {
                    if (eventSource && eventSource.url) {
                        const url = new URL(eventSource.url);
                        const urlSessionId = url.searchParams.get('sessionId');
                        if (urlSessionId) {
                            sessionId = urlSessionId;
                            log('Session ID from URL: ' + sessionId);
                        }
                    }
                }, 1000);

            } catch (error) {
                log('Connection error: ' + error.message);
                updateStatus('Connection Failed');
            }
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                sessionId = null;
                updateStatus('Disconnected');
                log('Disconnected from server');
            }
        }

        async function sendMCPRequest(method, params = {}) {
            if (!sessionId) {
                // Try to get sessionId from eventSource
                if (eventSource && eventSource.url) {
                    const url = new URL(eventSource.url);
                    sessionId = url.searchParams.get('sessionId');
                }
                
                if (!sessionId) {
                    log('Error: No session ID available. Please connect first.');
                    return;
                }
            }

            const request = {
                jsonrpc: '2.0',
                id: Date.now(),
                method: method,
                params: params
            };

            try {
                log('Sending MCP request: ' + JSON.stringify(request, null, 2));
                
                const response = await fetch(`http://localhost:3000/messages?sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });

                if (response.ok) {
                    const result = await response.text();
                    log('MCP response: ' + result);
                } else {
                    const error = await response.text();
                    log('MCP error response: ' + error);
                }
            } catch (error) {
                log('Request error: ' + error.message);
            }
        }

        function testToolsList() {
            sendMCPRequest('tools/list');
        }

        function testToolsCall() {
            sendMCPRequest('tools/call', {
                name: 'get_orders',
                arguments: {
                    limit: 5,
                    status: 'completed'
                }
            });
        }

        function testCustomToolCall() {
            const toolName = document.getElementById('toolName').value;
            if (!toolName) {
                log('Error: Please enter a tool name');
                return;
            }

            sendMCPRequest('tools/call', {
                name: toolName,
                arguments: {
                    limit: 3
                }
            });
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Auto-connect when page loads
        window.onload = function() {
            log('Page loaded. Click Connect to start testing.');
        };
    </script>
</body>
</html>
